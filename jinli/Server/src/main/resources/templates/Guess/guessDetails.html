<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="Pragma" content="no-cache">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"/>
    <title>Title</title>
    <link rel="stylesheet" th:href="@{/config/static/layui/css/layui.css}" defer="defer">
    <link rel="stylesheet" th:href="@{/config/static/css/mainCss.css}" defer="defer">
    <link rel="stylesheet" th:href="@{/config/static/css/InputAnimation.css}">
    <link rel="stylesheet" th:href="@{/config/static/css/upLoadImg.css}" defer="defer">
    <script type="text/javascript" th:src="@{/config/static/js/jq.js}"></script>
    <script type="text/javascript" th:src="@{/config/static/layui/layui.js}"></script>
    <script type="text/javascript" th:src="@{/config/static/js/config.js}"></script>
    <script type="text/javascript" th:src="@{/config/static/js/upLoadImg.js}"></script>
    <style type="text/css">
        .titleMsg>h2,.titleMsg>div{
            float: left;
        }
        .titleMsg>div{
            margin-top: 38px;
        }
        .formStyle{
            background-color: #fff;
            padding: 10px 30px;
            margin-top: 30px;
        }

        .firstEle{
            margin-left: 20px;
        }
        .imgBox{
            overflow: hidden;
            padding: 20px;
        }
        #loadHtml{
            padding: 0 30px;
        }
        .imgBox>div{
            width: 400px;
            height: 400px;
            overflow: hidden;
            float: left;
            margin-left: 30px;
            margin-bottom: 30px;
        }
        .layui-layer-dialog{
            width:auto!important;
        }
        @media screen and (max-width: 1000px) {
            .firstEle{
                margin-left: 0;
            }
        }
        .layui-form-pane .layui-form-label{
            width: 140px;
        }
        .layui-input{
            width: 30%;
            margin-left: 40px;
            padding-right:0;!important;
        }
        .formItemStyle{
            padding:10px 0 10px 0;
        }
        .layui-form-select {
            width: 250px;
            margin-left: 40px;
        }
        input[class="layui-input layui-unselect"]{
            margin-left: 0;
            width: 100%;
        }
        input[class="layui-input guessItem"]{
            width: 100%;
            margin-left: 0;
        }
        .layui-form-pane .layui-form-item[pane] .layui-input-inline{
            margin-left: 40px;
        }
        .guessItem{
            margin-top: 10px;
        }
        .guessItem:nth-child(1){
            margin-top: 0;
        }
        #upWindowImg,#upGuessImg{
            margin-left: 40px;
        }

    </style>
</head>
<body>
<div class="bgcSidebar"></div>
<div class="container app">
    <header>
        <!--头部导航-->
        <ul class="layui-nav overStyle" lay-filter="">
            <li class="logoOver"><div class="logoBox"><img class="logo" th:src="@{/config/static/img/default_logo.png}"></div><div class="logoText">锦鲤直播</div></li>
            <!--<li class="layui-nav-item toItemChange" data-path="index"><a href="javascript:void(0);" >首页</a></li>-->
            <!--<li class="layui-nav-item toItemChange" data-path="LiveUserExamine"><a href="javascript:void(0);" >主播管理</a></li>-->
            <!--<li class="layui-nav-item toItemChange" data-path="reportList"><a href="javascript:void(0);" >举报管理</a></li>-->
            <!--<li class="layui-nav-item  toItemChange" data-path="personDiaryList"><a href="javascript:void(0);">动态审核</a></li>-->
            <!--<li class="layui-nav-item  layui-this toItemChange" data-path="guessList"><a href="javascript:void(0);">竞猜管理</a></li>-->
            <!--<li class="layui-nav-item toItemChange" data-path="backOfficeManagement"><a href="javascript:void(0);">后台账号管理</a></li>-->
            <li class="userMsg">
                <div>
                    <span>欢迎您：</span>
                    <span id="loginName">admin</span>
                </div>
                <div>
                    <a href="/logout"><button class="layui-btn layui-btn-danger" id="logout" >退出</button></a>
                </div>
            </li>
        </ul>
    </header>
    <main class="mainStyle">
        <!--侧边栏-->
        <div class="sidebar">
            <div>
                <ul class="layui-nav layui-nav-tree overStyle leftSide" id="sidebar" lay-filter="test">
                    <!--<li class="layui-nav-item"><a  class="toItemChange" data-path="guessList" href="javascript:void(0);">竞猜展示列表</a></li>-->
                    <!--<li class="layui-nav-item"><a  class="toItemChange" data-path="guessNotStart" href="javascript:void(0);">尚未开始</a></li>-->
                    <!--<li class="layui-nav-item "><a  class="toItemChange" data-path="guessShowOver" href="javascript:void(0);">展示已结束</a></li>-->
                    <!--<li class="layui-nav-item "><a  class="toItemChange" data-path="guessWagerOver" href="javascript:void(0);">投注已结束</a></li>-->
                    <!--<li class="layui-nav-item "><a  class="toItemChange" data-path="guessWaitPrize" href="javascript:void(0);">待开奖</a></li>-->
                    <!--<li class="layui-nav-item "><a  class="toItemChange" data-path="guessStatistics" href="javascript:void(0);">数据统计</a></li>-->
                </ul>
                <div class="mainBox clearfix" id="loadHtml">
                    <div class="titleMsg clearfix">
                        <div>
                            <button type="button" class="layui-btn layui-btn-primary" onclick="window.history.back(-1)">
                                <i class="layui-icon">&#xe603;</i>
                            </button>
                        </div>
                        <h2 class="headMsg">编辑竞猜</h2>
                    </div>
                    <div>
                        <div>
                            <form class="layui-form layui-form-pane formStyle" action="">
                                <div class="layui-form-item" pane>
                                    <label class="layui-form-label">竞猜标题</label>
                                    <div class="layui-input-block layui-row formItemStyle">
                                        <input type="text" name="title" required  lay-verify="required" placeholder="请输入标题" autocomplete="off" class="layui-input" id="title">
                                    </div>
                                </div>
                                <div class="layui-form-item" pane>
                                    <label class="layui-form-label">竞猜副标题</label>
                                    <div class="layui-input-block formItemStyle clearfix">
                                        <input type="text" name="title" required  lay-verify="required" placeholder="请输入副标题" autocomplete="off" class="layui-input" id="subtitle">
                                    </div>
                                </div>
                                <div class="layui-form-item" pane>
                                    <label class="layui-form-label">窗口图片</label>
                                    <div class="layui-input-block formItemStyle" id="ImgWin">
                                        <div id="upWindowImg"></div>
                                    </div>
                                </div>
                                <div class="layui-form-item" pane>
                                    <label class="layui-form-label">竞猜页图片</label>
                                    <div class="layui-input-block formItemStyle" id="ImgGuess">
                                        <div id="upGuessImg"></div>
                                    </div>
                                </div>
                                <div class="layui-form-item" pane>
                                    <label class="layui-form-label">竞猜选项</label>
                                    <div class="layui-input-block formItemStyle" id="itemListBox">
                                        <div class="clearfix">
                                            <i class="layui-icon layui-icon-add-1 addItem" style="font-size: 30px; color: #2ea040;cursor: pointer;margin-left: 40px;"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="layui-form-item" pane>
                                    <label class="layui-form-label">展示开始时间</label>
                                    <div class="layui-input-block formItemStyle">
                                        <input type="text" class="layui-input" id="showStartTime">
                                    </div>
                                </div>
                                <div class="layui-form-item" pane>
                                    <label class="layui-form-label">展示结束时间</label>
                                    <div class="layui-input-block formItemStyle">
                                        <input type="text" class="layui-input" id="showEndTime">
                                    </div>
                                </div>
                                <div class="layui-form-item" pane>
                                    <label class="layui-form-label">下注开始时间</label>
                                    <div class="layui-input-block formItemStyle">
                                        <input type="text" class="layui-input" id="wagerStartTime">
                                    </div>
                                </div>
                                <div class="layui-form-item" pane>
                                    <label class="layui-form-label">下注结束时间</label>
                                    <div class="layui-input-block formItemStyle">
                                        <input type="text" class="layui-input" id="wagerEndTime">
                                    </div>
                                </div>
                                <div class="layui-form-item" pane>
                                    <label class="layui-form-label">排序</label>
                                    <div class="layui-input-block formItemStyle clearfix">
                                        <input type="number" class="layui-input" placeholder="1 至 100" id="guessSort">
                                    </div>
                                </div>
                                <div class="layui-form-item" pane>
                                    <label class="layui-form-label">竞猜类型</label>
                                    <div class="layui-input-block formItemStyle">
                                        <select  name="city" lay-verify="required" lay-filter="handle" class="selectStyle" id="typeSelect">
                                            <option value="0">政治</option>
                                            <option value="1">体育</option>
                                            <option value="2">电竞</option>
                                            <option value="3">其他</option>
                                        </select>
                                    </div>
                                </div>

                                <div id="confirmBtnBox">

                                </div>
                                <button class="layui-btn layui-btn-normal" type="button" id="upData">提交</button>
                                <button class="layui-btn layui-btn-normal" type="button"  onclick="window.history.back(-1)">返回</button>
                            </form>

                        </div>
                    </div>
                    <div class="mtBox"></div>
                </div>
                <div class="clearFloat"></div>
            </div>
        </div>
    </main>
</div>
<script type="text/javascript" th:src="@{/config/static/js/mainMethod.js}"></script>
<script type="text/javascript" th:inline="javascript">

    layui.use('layer', function(){
        var layer = layui.layer
    });
    layui.use('element', function(){
        var element = layui.element;
    });
    layui.use('laydate', function(){
        var laydate = layui.laydate;
        laydate.render({
            elem: '#test1'
        });
        laydate.render({
            elem: '#test2'
        });
    });

    layui.use('laydate', function(){
        var laydate = layui.laydate;
        laydate.render({
            elem: '#showStartTime'
            ,type: 'datetime'
        });
    });
    layui.use('laydate', function(){
        var laydate = layui.laydate;
        laydate.render({
            elem: '#showEndTime'
            ,type: 'datetime'
        });
    });
    layui.use('laydate', function(){
        var laydate = layui.laydate;
        laydate.render({
            elem: '#wagerStartTime'
            ,type: 'datetime'
        });
    });
    layui.use('laydate', function(){
        var laydate = layui.laydate;
        laydate.render({
            elem: '#wagerEndTime'
            ,type: 'datetime'
        });
    });

    layui.use('form', function(){
        var form = layui.form;
        form.on('select(itemSelect)', function(data){
            var itemSize = data.value;
            console.log("触发");
            $("#itemListBox").get(0).innerHTML = "";
            for(var i = 0;i<itemSize;i++){
                var itemNum = i+1;
                $("#itemListBox").get(0).innerHTML += '<input type="text" name="title" required  lay-verify="required" placeholder="选项'+itemNum+'" autocomplete="off" class="layui-input guessItem">';
            }
        });
    });

    var data = [[${data}]];
    if(data == "CANNOT_MODIFY"){
        window.history.back(-1)
    }
    console.log(data);
    inserData()
    function inserData() {
        $("#title").val(data.title);
        $("#subtitle").val(data.subtitle);
        $("#bet").val(data.bet);
        $("#itemSelect").val(data.itemList.length);
        $("#showStartTime").val(formatDate(data.showStartTime));
        $("#showEndTime").val(formatDate(data.showEndTime));
        $("#wagerStartTime").val(formatDate(data.wagerStartTime));
        $("#wagerEndTime").val(formatDate(data.wagerEndTime));
        $("#guessSort").val(data.sort);
        upGuessImgCallBack(data.guessImg);
        upWindowImgCallBack(data.windowImg);
        switch (data.guessType) {
            case "POLITICS":
                $("#typeSelect").val(0);
                break;
            case "SPORTS":
                $("#typeSelect").val(1);
                break;
            case "ELECTRONIC":
                $("#typeSelect").val(2);
                break;
            case "OTHER":
                $("#typeSelect").val(3);
                break
        }
        for(var i=0;i<data.itemList.length;i++){
            $("#itemListBox").get(0).innerHTML += '<div class="clearfix itemBoxDel">' +
                '                                 <div class="layui-input-inline">' +
                '                                 <input type="text" name="title" required  lay-verify="required" value="'+data.itemList[i].optionContent+'" autocomplete="off" class="layui-input guessItem" >' +
                '                                 </div>' +
                '                                 <div  class="layui-form-mid layui-word-aux">' +
                '                                 <i class="layui-icon layui-icon-subtraction delItem" style="font-size: 30px; color: #ff0a00;cursor: pointer;"></i>' +
                '                                 </div>' +
                '                                 </div>'
        }
    }
    changeInte()
    function changeInte() {
        $(document).on("click",".delItem",function () {
            console.log("触发");
            var itemNum = document.getElementsByClassName("guessItem")
            if(itemNum.length<=2){
                layer.open({
                    title: '错误信息'
                    ,content: '至少需要2个选项'
                });
            }
            else {
                var box = this.parentNode.parentNode;
                box.remove();
            }
        })
        $(document).on("click",".addItem",function () {
            console.log("触发");
            var itemNum = document.getElementsByClassName("guessItem")
            if(itemNum.length>=8){
                layer.open({
                    title: '错误信息'
                    ,content: '最多8个选项'
                });
            }
            else {
                $("#itemListBox").get(0).innerHTML += '<div class="clearfix itemBoxDel">' +
                    '                                 <div class="layui-input-inline">' +
                    '                                 <input type="text" name="title" required  lay-verify="required" autocomplete="off" class="layui-input guessItem" >' +
                    '                                 </div>' +
                    '                                 <div  class="layui-form-mid layui-word-aux">' +
                    '                                 <i class="layui-icon layui-icon-subtraction delItem" style="font-size: 30px; color: #ff0a00;cursor: pointer;"></i>' +
                    '                                 </div>' +
                    '                                 </div>'
            }
        })
    }


    var upGuessImg = data.guessImg;
    var upWindowImg = data.windowImg;

    function upGuessImgCallBack(res) {
        upGuessImg = res;
        console.log(res);
        $("#ImgGuess").get(0).innerHTML ="";
        $("#ImgGuess").get(0).innerHTML +='<button style="margin-left: 40px;position: absolute;top: 10px;" class="layui-btn layui-btn-normal" id="resetUpGuessImgBtn" type="button">重新上传</button>'+
            '<img class="lookImg" style="width: 40%;margin-left: 150px" src="'+window.config.imgUrl+"/"+upGuessImg+'" data-value="'+window.config.imgUrl+"/"+upGuessImg+'" type="button">';
        $(".lookImg").on("click",function () {
            openLayer(this.getAttribute("data-value"));
        });
        $("#resetUpGuessImgBtn").on("click",function () {
            $("#ImgGuess").get(0).innerHTML ="";
            $("#ImgGuess").get(0).innerHTML +='<div id="upGuessImg"></div>';
            intiUpLoad("upGuessImg",upGuessImgCallBack);
        })
    }
    function upWindowImgCallBack(res) {
        upWindowImg =res;
        $("#ImgWin").get(0).innerHTML ="";
        $("#ImgWin").get(0).innerHTML +='<button style="margin-left: 40px;position: absolute;top: 10px;" class="layui-btn layui-btn-normal" id="resetUpWindowImgBtn" type="button">重新上传</button>'+
            '<img class="lookImg" style="width: 40%;margin-left: 150px" src="'+window.config.imgUrl+"/"+upWindowImg+'" data-value="'+window.config.imgUrl+"/"+upWindowImg+'" type="button">';
        $(".lookImg").on("click",function () {
            openLayer(this.getAttribute("data-value"));
        });
        $("#resetUpWindowImgBtn").on("click",function () {
            $("#ImgWin").get(0).innerHTML ="";
            $("#ImgWin").get(0).innerHTML +='<div id="upWindowImg"></div>';
            intiUpLoad("upWindowImg",upWindowImgCallBack);
        })
    }

var send ={};
    function updata() {
        var itemList = [];
        var itemElList = document.getElementsByClassName("guessItem");
        for(var i=0;i<itemElList.length;i++){
            itemList.push(itemElList[i].value)
        }
        var title = $("#title").val();
        var subtitle = $("#subtitle").val();
        var windowImg = upWindowImg;
        var guessImg = upGuessImg;
        var guessType = $("#typeSelect").val();
        var showStartTime = new Date($("#showStartTime").val()).getTime();
        var showEndTime = new Date($("#showEndTime").val()).getTime();
        var wagerStartTime = new Date($("#wagerStartTime").val()).getTime();
        var wagerEndTime = new Date($("#wagerEndTime").val()).getTime();
        var sort = $("#guessSort").val();
        send.id = data.id;
        send.itemList = itemList;
        send.title = title;
        send.subtitle = subtitle;
        if (windowImg.charAt(0) =="/"){
            send.windowImg = windowImg.substr(1);
        }
        else {
            send.windowImg = windowImg
        }
        if (guessImg.charAt(0) =="/"){
            send.guessImg = guessImg.substr(1);
        }
        else {
            send.guessImg = guessImg
        }
        send.guessType = parseInt(guessType);
        send.showStartTime = showStartTime;
        send.showEndTime = showEndTime;
        send.wagerStartTime = wagerStartTime;
        send.wagerEndTime=wagerEndTime;
        send.sort = parseInt(sort);
        var sendOk = upLoadVerification(send,1);
        var nowTime = new Date().getTime();
        if(showStartTime !== data.showStartTime){
            console.log("展示开始时间");
            console.log(nowTime);
            if(showStartTime < nowTime){
                sendOk.msg = "任意修改的时间不得小于当前时间";
                sendOk.code = 408
            }
        }
        if(showEndTime !== data.showEndTime){
            console.log("展示结束时间");
            console.log(nowTime);
            if(showEndTime < nowTime){
                sendOk.msg = "任意修改的时间不得小于当前时间";
                sendOk.code = 408
            }
        }if(wagerStartTime !== data.wagerStartTime){
            console.log("下注开始时间");
            console.log(nowTime);
            if(wagerStartTime < nowTime){
                console.log("修改");
                sendOk.msg = "任意修改的时间不得小于当前时间";
                sendOk.code = 408
            }
        }
        if(wagerEndTime !== data.wagerEndTime){
            console.log("下注结束时间");
            console.log(nowTime);
            if(wagerEndTime < nowTime){
                sendOk.msg = "任意修改的时间不得小于当前时间";
                sendOk.code = 408
            }
        }

        console.log(send);
        console.log(sendOk);
        if(sendOk.code === 200){
            send.itemList = JSON.stringify(itemList);
            $.get({
                url:window.ioApi.guess.guessEdit,
                data:send,
                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                success:function (res) {
                    layer.confirm('修改成功',{
                        btn: ['确认'] ,
                        area: ['500px']
                    },function (index) {
                        window.history.back(-1)
                    });
                },
                error:function(xhr, exception){
                    layer.open({
                        title: '错误信息'
                        ,content: '服务器错误，请联系管理员'
                    });
                }
            })
        }
        else if(sendOk.code === 400){
            var nullKey;
            switch (sendOk.nullKey) {
                case "itemList":
                    nullKey = "竞猜选项";
                    break;
                case "title":
                    nullKey = "竞猜标题";
                    break;
                case "subtitle":
                    nullKey = "竞猜副标题";
                    break;
                case "windowImg":
                    nullKey = "窗口图片";
                    break;
                case "guessImg":
                    nullKey = "竞猜页图片";
                    break;
                case "guessType":
                    nullKey = "竞猜类型";
                    break;
                case "showStartTime":
                    nullKey = "展示开始时间";
                    break;
                case "showEndTime":
                    nullKey = "展示结束时间";
                    break;
                case "wagerStartTime":
                    nullKey = "下注开始时间";
                    break;
                case "wagerEndTime":
                    nullKey = "下注结束时间";
                    break;
                case "sort":
                    nullKey = "排序";
                    break
            }
            layer.open({
                title: '错误信息'
                ,content: '竞猜信息 "'+nullKey+'" 为空'
            });
        }
        else {
            layer.open({
                title: '错误信息'
                ,content: sendOk.msg
            });
        }
    }

    $("#upData").on("click",function () {
        updata()
    });
    function openLayer(imgSrc) {
        layer.open({
            title: '查看图片详情'
            ,content:"<img src='"+imgSrc+"' style='width: 700px' >",
            offset: '100px'
        });
    }
    
    $("#resetData").on("click",function () {
        window.history.back(-1);
    })

</script>
</body>
</html>